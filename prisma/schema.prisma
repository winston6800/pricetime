// Loop Burn Engine - Database Schema
// Uses PostgreSQL (Neon for production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User managed by Clerk, we store user data
model User {
  id        String   @id // Clerk user ID
  clerkId   String   @unique
  email     String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userData       UserData?
  taskHistory    TaskHistory[]
  openLoops      OpenLoop[]
  incomeEntries  IncomeEntry[]
  stripeCustomer StripeCustomer?
  subscription   Subscription?
  
  @@index([clerkId])
}

// User data (current state, preferences)
model UserData {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Current task state
  hourlyRate    Float    @default(90)
  currentTask   String?  @default("")
  category      String?  @default("rock") // 'rock', 'pebble', 'sand'
  timer         Int      @default(0) // seconds
  timerStartTime BigInt? // UTC timestamp in milliseconds when timer started
  
  // UI preferences
  showMinerals  Boolean  @default(true)
  taskHistoryMinimized Boolean @default(false)
  openLoopsMinimized Boolean @default(false)
  
  // Login streak
  loginStreak   Int      @default(1)
  lastLoginDate String?  // Date string (local)
  
  // Outcomes Dashboard (Pro feature)
  goalTarget    Float?   // Target amount in dollars
  goalMotivation String? // Short motivation text (e.g., "Retire Mom & Dad")
  goalCreatedAt BigInt?  // UTC timestamp in milliseconds when goal was committed
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
}

// Task history (completed tasks)
model TaskHistory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String
  category  String   // 'rock', 'pebble', 'sand'
  cost      String   // Money spent (formatted string)
  timestamp BigInt   // UTC timestamp in milliseconds
  duration  Int      // Duration in seconds
  valueEarned Float  @default(0) // Value earned from this task (Pro feature)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([timestamp])
}

// Open loops (distractions)
model OpenLoop {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String
  timer     Int      @default(0) // seconds
  rate      Float    @default(1000) // hourly rate
  isActive  Boolean  @default(false)
  timerStartTime BigInt? // UTC timestamp in milliseconds when timer started
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

// Manual income entries (Outcomes Dashboard)
model IncomeEntry {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount    Float    // Amount in dollars
  note      String?  // Optional note/description
  timestamp BigInt   // UTC timestamp in milliseconds
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([timestamp])
}

// Stripe customer (links Clerk user to Stripe)
model StripeCustomer {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripeCustomerId String   @unique // Stripe's customer ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([stripeCustomerId])
}

// Subscription (tracks user's Pro subscription status)
model Subscription {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripeSubscriptionId  String   @unique // Stripe's subscription ID
  status                String   // active, canceled, past_due, trialing, unpaid
  plan                  String   @default("free") // free, pro
  currentPeriodEnd      DateTime // When current billing period ends
  cancelAtPeriodEnd     Boolean  @default(false) // Will cancel at period end
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([status])
}
